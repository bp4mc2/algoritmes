<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta charset="utf-8">
<meta name="generator" content="ReSpec 34.2.2">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;color:#000;box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;margin-top:.25em}
.dfn-panel ul a[href]{color:#333}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
  
  
  
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
:is(h1,h2,h3,h4,h5,h6,a) abbr{border:none}
dfn{font-weight:700}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
.toc a,.tof a{text-decoration:none}
a .figno,a .secno{color:#000}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
table.simple{border-spacing:0;border-collapse:collapse;border-bottom:3px solid #005a9c}
.simple th{background:#005a9c;color:#fff;padding:3px 5px;text-align:left}
.simple th a{color:#fff;padding:3px 5px;text-align:left}
.simple th[scope=row]{background:inherit;color:inherit;border-top:1px solid #ddd}
.simple td{padding:3px 10px;border-top:1px solid #ddd}
.simple tr:nth-child(even){background:#f0f6ff}
.section dd>p:first-child{margin-top:0}
.section dd>p:last-child{margin-bottom:0}
.section dd{margin-bottom:1em}
.section dl.attrs dd,.section dl.eldef dd{margin-bottom:0}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
  
<title>IMAR - Informatiemodel Algoritme register</title>

<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#000}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#000;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "latestVersion": "https://bp4mc2.github.io/algoritmes/",
  "specStatus": "unofficial",
  "shortName": "imar",
  "group": "webapps",
  "xref": "web-platform",
  "editors": [
    {
      "name": "Taco Paul Reijer"
    },
    {
      "name": "Arjen Santema"
    }
  ],
  "logos": [
    {
      "src": "https://avatars.githubusercontent.com/u/86524793?s=200&v=4",
      "alt": "Algoritme register",
      "id": "ar-logo"
    }
  ],
  "github": "https://github.com/bp4mc2/algoritmes",
  "issueBase": "https://github.com/bp4mc2/algoritmes/issues/",
  "edDraftURI": "https://bp4mc2.github.io/algoritmes/",
  "publishISODate": "2023-12-22T00:00:00.000Z",
  "generatedSubtitle": "Unofficial Draft 22 December 2023"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2021/W3C-UD"></head>

<body class="h-entry informative" data-cite="HTML INFRA URL WEBIDL DOM FETCH"><div class="head">
    <p class="logos"><a class="logo"><img crossorigin="" alt="Algoritme register" id="ar-logo" src="https://avatars.githubusercontent.com/u/86524793?s=200&amp;v=4">
  </a></p>
    <h1 id="title" class="title">IMAR - Informatiemodel Algoritme register</h1> 
    <p id="w3c-state">Unofficial Draft <time class="dt-published" datetime="2023-12-22">22 December 2023</time></p>
    <details open="">
      <summary>More details about this document</summary>
      <dl>
        <dt>This version:</dt><dd>
                <a class="u-url" href="https://www.w3.org/TR/unofficial-imar-20231222/">https://www.w3.org/TR/unofficial-imar-20231222/</a>
              </dd>
        <dt>Latest published version:</dt><dd>
                <a href="https://bp4mc2.github.io/algoritmes/">https://bp4mc2.github.io/algoritmes/</a>
              </dd>
        <dt>Latest editor's draft:</dt><dd><a href="https://bp4mc2.github.io/algoritmes/">https://bp4mc2.github.io/algoritmes/</a></dd>
        <dt>History:</dt><dd>
                    <a href="https://github.com/bp4mc2/algoritmes/commits/">Commit history</a>
                  </dd>
        
        
        
        
        
        <dt>Editors:</dt><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Taco Paul Reijer</span>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Arjen Santema</span>
  </dd>
        
        
        <dt>Feedback:</dt><dd>
        <a href="https://github.com/bp4mc2/algoritmes/">GitHub bp4mc2/algoritmes</a>
        (<a href="https://github.com/bp4mc2/algoritmes/pulls/">pull requests</a>,
        <a href="https://github.com/bp4mc2/algoritmes/issues/new/choose">new issue</a>,
        <a href="https://github.com/bp4mc2/algoritmes/issues/">open issues</a>)
      </dd>
        
        
      </dl>
    </details>
    
    
    <p class="copyright">
      Copyright ©
      2023
      the document editors/authors.
      Text is available under the
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/legalcode">Creative Commons Attribution 4.0 International Public License</a>; additional terms may apply.
    </p>
    <hr title="Separator for header">
  </div>
  <section id="abstract" class="introductory"><h2>Abstract</h2></section>
  <section id="sotd" class="introductory"><h2>Status of This Document</h2><p>
      This document is a draft of a potential specification. It has no official
      standing of any kind and does not represent the support or consensus of
      any standards organization.
    </p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#H1"><bdi class="secno">1. </bdi>Inleiding</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#modeldocumentatie"><bdi class="secno">1.1 </bdi>Modeldocumentatie</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#algoritme"><bdi class="secno">1.1.1 </bdi>Algoritme</a></li><li class="tocline"><a class="tocxref" href="#views-op-w3c-vocabulaiies"><bdi class="secno">1.1.2 </bdi>Views op W3C vocabulaiies</a></li><li class="tocline"><a class="tocxref" href="#datatypes"><bdi class="secno">1.1.3 </bdi>Datatypes</a></li></ol></li></ol></li></ol></nav>
  <section id="H1" data-format="markdown"><div class="header-wrapper"><h2 id="x1-inleiding"><bdi class="secno">1. </bdi>Inleiding</h2><a class="self-link" href="#H1" aria-label="Permalink for Section 1."></a></div>
<p>Dit document beschrijft het informatiemodel voor de governance op algoritmische toepassingen. Het is een logisch model conform het <a href="https://docs.geostandaarden.nl/mim/mim/">Metamodel voor InformatieModellen</a> (MIM niveau 3).</p>
<p>Alle relevante begrippen rond algoritmen zijn gedefinieerd in de begrippencatalogus voor algoritme begrippen. Deze begrippencatalogus is tevens de bron van alle definities die in dit informatiemodel worden gehanteerd.</p>
<p>De kern van het model is gebaseerd op de Nederlandse algoritmestandaard. Deze standaard is in eerste instantie ontwikkeld als een rechttoe rechtaan lijst met een aantal gegevens die relevant zijn om algoritmes in een algoritmeregister te beschrijven. Dat is een belangrijke stap binnen de overheid om de toepassing van algoritmes en de implicaties en risico’s voor de samenleving inzichtelijk te maken. </p>
<p>Voor governance op algoritmische toepassingen is een meer genuanceerde benadering nodig. Daarbij is het relevant om onderscheid te maken tussen een algoritmische toepassing, de algortimes zelf en gebruikte methoden en technieken. De algoritmische toepassing heeft al dan niet maatschappelijke impact. Binnen 1 toepassing kunnen meerdere algoritmes worden ingezet. En om hergebruik van in algoritmes gebruikte methoden en technieken mogelijk te maken is ook het expliciet onderscheiden hiervan relevant.</p>
<p>Daarnaast maakt het model gebruik van bestaande semantische standaarden zoals <a href="https://www.w3.org/TR/vocab-dcat-3/">dcat</a> (Data Catalog Vocabulary) voor het beschrijven van datasets en <a href="https://www.w3.org/TR/vocab-adms/">adms</a> (Asset Description Metadata Schema) voor het beschrijven van semantic assets. Door een algortimeregister te beschrijven als asset repository en een algoritmische toepassing te beschrijven als ‘semantic asset’ worden algoritmeregisters en de daarin beschreven algoritmische toepassingen als zodanig vindbaar op het web. Ook kan daarmee een verbinding worden gemaakt met &lt;https: data.overheid.nl=""&gt;. Data.overheid wordt gevuld op basis van beschrijvingen van datasets op basis van dcat.</p>
<section id="modeldocumentatie"><div class="header-wrapper"><h3 id="x1-1-modeldocumentatie"><bdi class="secno">1.1 </bdi>Modeldocumentatie</h3><a class="self-link" href="#modeldocumentatie" aria-label="Permalink for Section 1.1"></a></div>
<p>In het informatiemodel voor algoritmes is opgebouwd uit verschillende bouwstenen (packages). </p>
<section id="algoritme"><div class="header-wrapper"><h4 id="x1-1-1-algoritme"><bdi class="secno">1.1.1 </bdi>Algoritme</h4><a class="self-link" href="#algoritme" aria-label="Permalink for Section 1.1.1"></a></div>
<p>Het domein Algoritme bevat de kern van het model. </p>
<p>Centraal in dit domein staan de objecttypen Algoritmeregister en Algoritmische toepassing. De algoritmische toepassing is een semantische asset die een aantal kenmerken hergebruikt uit adms en daarmee indirect ook enkele kenmerken uit dcat (adms is een profiel op dcat). Het algoritmeregister is een asset repository en hergebruikt eveneens een aantal kenmerken uit adms en dcat. Deze algemene, door de <a href="https://www.w3.org/">W3C</a> (World Wide Web Consortium) aanbevolen standaard kenmerken zijn direct interpreteerbaar voor bijvoorbeeld zoekmachines en worden ook gebruikt in data.overheid.</p>
<p>1 algoritmische toepassing kan meerdere algoritmes gebruiken, bijvoorbeeld een combinatie van regelgebaseerde en zelflerende algoritmes. Met zo’n combinatie kan de betrouwbaarheid van de uitkomst worden verhoogd of kunnen zelflerende algoritmes via de toegepaste regels uitleggen hoe ze tot een resultaat zijn gekomen. Ook is denkbaar dat bijvoorbeeld voor de herkenning van bepaalde feiten en namen in teksten verschillende algoritmes worden ingezet. Deze algoritmes zijn niet geheel onafhankelijk: als iets een feit is, is het geen naam en andersom. </p>
<p>1 algoritme kan vervolgens weer meerdere methoden of modellen gebruiken. In het voorbeeld van de herkenning van entiteiten in teksten kan eerst een methode worden gebruikt om teksten op te splitsen in woorden en vervolgens een beproefd open source algoritme om Nederlands te herkennen en tot slot een specifiek algoritme voor het herkennen van namen in Nederlandse teksten. Methoden en technieken zijn in de regel ergens beschreven en kunnen op basis van hun documentatie worden hergebruikt. </p>
<p>Voor het beschrijven van documentatie wordt een algemeen patroon gebruikt. In zijn meest eenvoudige vorm is er een eenvoudige beschrijving, maar idealiter is er een webpagina met meer informatie. Documentatie kan betrekking hebben op een bezwaarprocedure met een beschrijving ‘er kan bezwaar worden gemaakt via een bezwaarformulier’, waarbij een url naar de webpagina met dit formulier gebruikelijk is. Maar het is ook mogelijk dat aan de beschrijving wordt toegevoegd ‘… dat kan worden opgevraagd bij de klantenservice’ of dat alleen de url naar een webpagina met een beschrijving van de procedure en een bezwaarformulier voldoende wordt gevonden.</p>
<p>Op dezelfde wijze kan ook een eventuele publiekspagina van een algoritmische toepassing, de beschrijving van het algoritmeregister zelf of de code base van een algoritme in bijvoorbeeld GitHub worden beschreven. Dit geldt ook voor een methode of model en voor een assessment. Deze zijn gemodelleerd als subtype van documentatie.</p>
<p>Een algoritmische toepassing heeft een (wettelijke) grondslag die beschrijft waarom een organisatie dit soort dingen mag of juist moet doen. Zo’n bron kan beschreven met een zin als ‘dit algoritme wordt ingezet na goedkeuring van ...’ of met een citeertitel en url die zijn ontleend aan wetten.nl.
In de meeste algoritmeregisters wordt voor iedere algoritmische toepassing een afbeelding opgenomen. Deze is gemodelleerd als een afbeelding conform het <a href="http://xmlns.com/foaf/0.1/">foaf</a> vocabularie. Foaf (friend of a friend) is een veel gebruikt vocabulaire dat is gemaakt om webpagina’s machine leesbaar te maken.</p>
<p>Zowel afbeeldingen, documentatie als grondslag zijn gemodelleerd als foaf documenten.</p>
<p>Algoritmische toepassingen kennen risico’s. Risico’s komen altijd naar boven uit een assesment. Op dit moment worden 2 typen assesment aanbevolen, namelijk een IAMA (Impact Assesment Mensenrechten en Algoritmes) en een DPIA (Data Protection Impact Assessment). De beschrijving van risico’s is met de kenmerken kans, ernst en mitigerende maatregelen uitgebreider dan de huidige standaard voorschrijft. Hiermee sluit deze beschrijving aan bij gebruikelijke risicoanalyses.</p>
<p>Tot slot is zowel de bevoegde organisatie of afdeling van belang die mag besluiten over de algoritmische toepassing als de organisatie of afdeling die de algoritmische toepassing uitvoert. Het model laat open of dit op afdelingsniveau of op organisatieniveau wordt vastgelegd. Voor de beschrijving van een organisatie of afdeling wordt de <a href="https://www.w3.org/TR/vocab-org/">org</a> (organisation) ontolgy van de W3C hergebruikt. Dit maakt het mogelijk aan te sluiten op het register van overheidsorganisaties.</p>
</section><section id="views-op-w3c-vocabulaiies"><div class="header-wrapper"><h4 id="x1-1-2-views-op-w3c-vocabulaiies"><bdi class="secno">1.1.2 </bdi>Views op W3C vocabulaiies</h4><a class="self-link" href="#views-op-w3c-vocabulaiies" aria-label="Permalink for Section 1.1.2"></a></div>
<p>Adms, dcat, foaf, org en vcard zijn beschreven door de W3C. In het voorliggende informatiemodel hebben we deze vocabulaires uitgedrukt in UML met een overzicht van de in het kader van algoritmes relevante kenmerken. De namen voor deze kenmerken zijn vertaald naar Nederlandse termen in de context van algoritmes. Dit is puur voor de leesbaarheid gedaan. Het is niet de bedoeling dat door eventuele andere associaties bij deze Nederlandse termen de betekenis van de oorspronkelijke kenmerken verandert. Voor alle kenmerken is een link naar het oorspronkelijke Engelstalige begrip en de definitie daarvan opgenomen.</p>
</section><section id="datatypes"><div class="header-wrapper"><h4 id="x1-1-3-datatypes"><bdi class="secno">1.1.3 </bdi>Datatypes</h4><a class="self-link" href="#datatypes" aria-label="Permalink for Section 1.1.3"></a></div>
<p>De datatypes bevatten in de eerste plaats referentielijsten naar bestaande waardelijsten voor:
*	thema (&lt;https: standaarden.overheid.nl="" owms="" 4.0="" doc="" waardelijsten="" thema-indeling-voor-officiele-publicaties=""&gt;)
*	taal (<a href="https://www.loc.gov/standards/iso639-2/php/English_list.php">https://www.loc.gov/standards/iso639-2/php/English_list.php</a>) </p>
<p>Daarnaast bevatten datatypes de binnen het domein van algoritmes nog te definiëren waardelijsten:
*	risico categorie (onaanvaardbaar, hoog, midden laag)
*	type assesment (IAMA, DPIA, …)
*	type methode of model (…)
*	risico of ernst (hoog, middel, laag)
*	kans (groot, gemiddeld, klein)
*	mitigerende maatregel (bewaken, berusten, …)
*	type algoritme ((deels)zelflerend, niet-zelflerend)
Hieronder is een overzicht van alle packages in de huidige versie van het model. </p>
<p>In het volgende hoofdstuk wordt het informatiemodel algoritme register in detail beschreven. 
</p>
</section></section></section>
  

<p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>